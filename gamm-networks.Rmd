---
title: "GAMM Networks"
author: "Nick Gauthier"
date: "February 14, 2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Setup

```{r }
#library(raster)
library(archdata)
library(maps)
library(tidyverse)
library(readxl)
library(mgcv)
library(ggmap)
library(sf)
# devtools::install_github('nspope/corMLPE')
library(corMLPE)
library(tidygraph)
library(ggraph)
```

## Oxford Pots
```{r}
data("OxfordPots")

pots <- OxfordPots %>%
  rename(to = Place) %>%
  gather(key, value, OxfordPct:NewForestDst) %>%
  separate(key, c('from', 'measure'), sep = -3) %>%
  spread(measure, value) %>%
  rename(percent = Pct, distance = Dst) %>%
  mutate(from = str_replace(from, 'NewForest', 'New Forest'))

pots
```

```{r}
ggplot(pots, aes(distance, percent, color = from)) +
  geom_point(aes(shape = as.factor(WaterTrans)))
```

```{r, eval = FALSE}
ggmap::register_google(key = "<your-api-key-here>")

pots_sites <- pots %>%
  select(from, to) %>% 
  gather %>%
  pull(value) %>%
  unique %>% 
  tibble(site = .) %>%
  mutate(search_term = str_replace_all(site, c('Clausentum' = 'Bitterne', 'Mildenhall' = 'Mildenhall, Wiltshire')),
         search_term = paste0(search_term, ', UK')) %>%
  mutate_geocode(search_term) %>%
  select(-search_term) %>%
  st_as_sf(coords = c('lon', 'lat'), crs = 4326) %>%
  bind_cols(., as_tibble(st_coordinates(.))) %>%
  rename(x = X, y = Y)

saveRDS(pots_sites, 'oxfordpots_locations.RDS')
```

```{r}
pots_sites <- readRDS('oxfordpots_locations.RDS') %>%
  left_join(select(pots, to, WalledArea) %>% group_by(to) %>% 
              summarise(area = mean(WalledArea)), by = c('site' = 'to'))
```

```{r, echop = FALSE}
st_distance(pots_sites) %>%
  `colnames<-`(pots_sites$site) %>%
  as_tibble %>%
  mutate(to = pots_sites$site) %>%
  gather(from, distance, `New Forest`:Wroxeter) %>%
  filter(to > from) %>%
  right_join(dat,by = c('from' = 'origin', 'to' = 'destination')) %>%
  mutate(distance.x = as.numeric(distance.x) / 1000) %>%
  ggplot(aes(distance.y, distance.x, color = from)) +
  geom_point() +
  geom_label(aes(label = to), alpha = .4)
```

```{r}
pots_net <- tbl_graph(nodes = pots_sites, edges = pots) %E>%
  filter(!is.na(percent)) %>%
  mutate(similarity = percent / 100)
```

```{r}
uk_boundary <- maps::map('world', region = 'UK',
                    fill = TRUE, plot = FALSE) %>%
  st_as_sf
```

```{r}
pots_net %E>%
  arrange(percent) %>%
ggraph() +
  geom_sf(data = uk_boundary, fill = NA) +
  geom_edge_link(aes(colour = percent), edge_width = 2, lineend = 'round') +
  geom_sf(data = filter(pots_sites, site %in% c('Oxford', 'New Forest')), size = 4) +
  scale_edge_color_distiller(palette = 'YlGnBu', guide = 'legend', name = 'Percentage of pottery \nfrom origin site') +
  labs(title = 'Ceramic distribution in Roman Britain', subtitle = 'Percentages of late Romano-British pottery produced in Oxford and New Forest') +
  coord_sf(datum = NA, xlim = c(-6, 2), ylim = c(50, 53.7)) +
  theme_void()
```

```{r}
pots_dat <- pots_net %E>%
  mutate(water = as.factor(WaterTrans == 1),
         x = .N()$x[to],
         y = .N()$y[to]) %>% 
  as_tibble %>%
  mutate(from = as.factor(from),
         to = as.factor(to))
```

Example of model selection.
```{r}
pots_models <- c("s(distance) + from",
            "s(distance) + water + from",
            "s(distance, by = water) + water + from") %>%
  paste('similarity ~', .) %>%
  tibble(formula_chr = .) %>%
  mutate(formula = map(formula_chr, as.formula), 
         model = map(formula, ~gam(.x, method = 'ML', family = betar(), data = pots_dat)),
         aic = map_dbl(model, AIC)) %>%
  arrange(aic)

pots_models
```

Refit the best performing model with REML and investigate.
```{r}
m1 <- gam(similarity ~ s(distance, by = water) + water + from,
          method = 'REML',
          select = TRUE,
          family = betar(),
          data = pots_dat)

summary(m1)
plot(m1, trans = plogis)
```
```{r echo = FALSE}
tmp1 <- expand.grid(distance = 0:140, water = c(TRUE, FALSE), from = 2)
predict(m1, tmp1, type = 'response', se.fit = TRUE) %>%
  bind_cols(tmp1) %>%
  mutate(fit = fit * 100,
         lower = fit - 2 * se.fit * 100,
         upper = fit + 2 * se.fit * 100) %>%
  ggplot(aes(distance, fit, group = water)) +
  geom_ribbon(aes(ymin = lower, ymax = upper, fill = water), alpha = .2) +
  geom_line(aes(y = fit, color = water), size = 1.2) +
  theme_minimal() +
  labs(title = 'Estimated distance decay functions', subtitle = 'With and without water transport',
       x = 'Distance (km)', y = 'Percentage of pottery from origin site')
```

```{r}
pots_net %E>%
  mutate(res = residuals(m1, type = 'response') * 100) %>%
  arrange(abs(res)) %>%
ggraph() +
  geom_sf(data = uk_boundary, fill = NA) +
  geom_edge_link(aes(colour = res), edge_width = 2, lineend = 'round') +
  geom_sf(data = filter(pots_sites, site %in% c('Oxford', 'New Forest')), size = 4) +
  scale_edge_color_distiller(palette = 'RdBu', limits = c(-8, 8), guide = 'legend', name = 'Difference from \nexpectation (%)') +
  labs(title = 'Ceramic distribution in Roman Britain', subtitle = 'Residuals from distance-only interaction model') +
  coord_sf(datum = NA, xlim = c(-6, 2), ylim = c(50, 53.7)) +
  theme_void()
```

## Data Import and Preprocessing

```{r}
chumash <- read.csv('chumash_marriage.csv', row.names = 1) %>%
  as.matrix %>%
  as_tbl_graph(directed = FALSE) %E>%
  filter(!edge_is_loop()) %N>%
  mutate(centrality = centrality_degree())
```

```{r}
raster('chumash_map_georeferenced.tif') %>% plot
```

```{r}
ggraph(chumash) +
  geom_edge_link(aes(width = weight), alpha = .1) +
  geom_node_point(aes(size = centrality)) +
  theme_void()
```

```{r}
stamps <- read_delim('stamps.csv', delim = ';')

stamps %>%
  group_by(site) %>%
  count %>%
  pull(n) %>% range
  ggplot(aes(n)) +
  geom_histogram()


ggplot(stamps, aes (lat, long)) +
  geom_density2d()

```


## iriquois
```{r}
lcp_groups <- read_xlsx('pone.0209689.s001.xlsx', sheet = 1) %>%
  rename(from = 1) %>%
  gather(to, lcp, 2:14)

euc_groups <- read_xlsx('pone.0209689.s001.xlsx', sheet = 3) %>%
  rename(from = 1) %>%
  gather(to, euc, 2:14) %>%
  mutate_if(is.character, ~str_replace_all(., ', ', '-')) %>%
  mutate_if(is.character, ~str_replace(., 'Trent River', 'Trent Valley')) %>%
  mutate_if(is_character, ~str_replace(., 'Lake Erie Plain-Niagara Frontier', 'Lake Erie Plain'))

br_groups <- read_xlsx('pone.0209689.s001.xlsx', sheet = 2) %>%
  rename(from = Cluster) %>%
  gather(to, similarity, 2:14) %>%
  mutate_if(is.character, ~str_replace_all(., ', ', '-')) %>%
  mutate_if(is.character, ~str_replace(., 'Trent River', 'Trent Valley')) %>%
  mutate_if(is_character, ~str_replace(., 'Lake Erie Plain-Niagara Frontier', 'Lake Erie Plain'))

dat <- full_join(lcp_groups, br_groups) %>%
  full_join(euc_groups) %>%
  filter(from < to )

m1 <- gam(similarity ~ s(lcp), data = dat, method = 'ML')
m2 <- gam(similarity ~ s(lcp), family = betar(), data = dat, method = 'ML')
m3 <- gamm(qlogis(similarity) ~ s(lcp), data = dat, correlation = corMLPE(form = ~from + to), method = 'ML')
plot(m3$gam, trans = plogis)

summary(m3$gam)
ggraph(net) +
  geom_edge_link()+
  geom_node_point()

'A' > 'B'
```
Check this: model without correlation structure shows a nonlinear effect, mainly because of a cluster of links at high distances that have moderate similarity.
```{r}
plot(m2, trans = plogis)
```
But all of these links come from the same site, so they are not independent. Adding the correlation structure fixes this
```{r}
plot(m3$gam, trans = plogis)
```

```{r}
m3$lme
# rho of 0.35!
```

```{r}
sites_groups <- read_xlsx('pone.0209689.s001.xlsx', sheet = 4, range = 'A2:B98')

br_sites_1400_1500 <- read_xlsx('pone.0209689.s001.xlsx', sheet = 4, range = 'C2:CU98') %>%
  rename(from = Site) %>%
  gather(to, similarity, 2:97) %>%
  mutate(similarity = similarity / 200)
dist_sites_1400_1450 <- read_xlsx('pone.0209689.s001.xlsx', sheet = 7, range = 'B2:CT98') %>%
  rename(from = Site) %>%
  gather(to, distance, 2:97) %>%
  mutate_if(is.character, ~str_replace(., 'Otstungo', 'Otsungo'))


br_sites_1450_1550 <- read_xlsx('pone.0209689.s001.xlsx', sheet = 5, range = 'B2:CA79') %>%
  rename(from = Site) %>%
  gather(to, similarity, 2:78) %>%
  mutate(similarity = similarity / 200)
dist_sites_1450_1550 <- read_xlsx('pone.0209689.s001.xlsx', sheet = 8, range = 'B2:CA79') %>%
  rename(from = Site) %>%
  gather(to, distance, 2:78) %>%
  mutate_if(is.character, ~str_replace(., 'Otstungo', 'Otsungo')) %>%
  mutate_if(is.character, ~str_replace(., '27/VII', '27VII'))

br_sites_1500_1600 <- read_xlsx('pone.0209689.s001.xlsx', sheet = 6, range = 'B2:BN66') %>%
  rename(from = Site) %>%
  gather(to, similarity, 2:65) %>%
  mutate(similarity = similarity / 200) %>%
  mutate_if(is.character, ~str_replace(., 'Wagners', "Wagner's"))
dist_sites_1500_1600 <- read_xlsx('pone.0209689.s001.xlsx', sheet = 9, range = 'B2:BN66') %>%
  rename(from = Site) %>%
  gather(to, distance, 2:65) %>%
  mutate_if(is.character, ~str_replace(., '27/VII', '27VII'))

```

```{r}
dat <- bind_rows(left_join(br_sites_1400_1500, dist_sites_1400_1450),
                 left_join(br_sites_1450_1550, dist_sites_1450_1550),
                 left_join(br_sites_1500_1600, dist_sites_1500_1600),
                 .id = 'time') %>%
  filter(from < to & similarity > 0)

  # inner_join(sites_groups, by = c('from'='Site')) %>%
  # inner_join(sites_groups, by = c('to'='Site')) %>%
  # mutate(same_region = Group.x == Group.y) %>%
  # select(-c(Group.x, Group.y))


qplot(distance, similarity, color = time, data = dat, geom = 'point') + geom_smooth()
```

```{r}
m1 <- gam(similarity ~ s(distance) + time, data = dat, method = 'ML')
m2 <- gam(similarity ~ s(distance) + time, family = betar(), data = dat, method = 'ML')
m3 <- gamm(qlogis(similarity) ~ s(distance, bs = 'cr') + as.factor(time), data = dat, correlation = corMLPE(form = ~from + to|as.factor(time)), method = 'REML')

m4 <- gamm(qlogis(similarity) ~ s(distance, bs = 'cr') + as.factor(time) + same_region, data = dat, correlation = corMLPE(form = ~from + to|time), method = 'REML')

plot(m1)
plot(m2, trans = plogis)

plot(m3$gam, trans = plogis)
plot(m4$gam, trans = plogis)

AIC(m3$lme, m4$lme)
# moderate support for regional effect
summary(m3$gam)
summary(m4$gam)
summary(m4$lme)


ggplot(dat, aes(distance)) + geom_histogram()
ggplot(dat, aes((similarity))) + geom_histogram()
ggplot(dat, aes(qlogis(similarity), fill = time)) + geom_histogram()
sum(min(dat$similarity))

gam.check(m3$gam)
```

```{r}
mod_time <- dat %>%
  group_by(time) %>%
  nest %>%
  mutate(model = map(data, ~gamm(qlogis(similarity) ~ s(distance, bs = 'cr'), 
                                 data = ., correlation = corMLPE(form = ~from + to), method = 'ML')),
         r2 = map_dbl(model, ~summary(.$gam)$r.sq))
mod_time

mod_time$model %>%
  map(~.$gam) %>%
  walk(plot, trans = plogis)
```


