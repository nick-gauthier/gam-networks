---
#---POSTER SIZE & DEFAULT FONT---#
poster_height: "36in" # height in inches of poster
poster_width: "48in" # width in inches of poster
font_family: "palatino" # choose from typical latex fonts (example: "palatino")
font_size: "30pt" #please see github.com/brentthorne/posterdown for compatible options.

#---TITLE BOX OPTIONS---#
#ESSENTIALS
title: '\fontfamily{phv}\selectfont Generalized additive mixed models for spatial networks'
author: "Nicolas Gauthier"
affiliation: "School of Human Evolution and Social Change, Arizona State University"
#STYLE & FORMATTING
titlebox_bgcol: "433E85"  #Colour of the Title Box background
titlebox_bordercol: "433E85" #Colour of the title Box border.
titlebox_shape: "all"
titlebox_borderwidth: "1cm"
title_textcol: "FFFFFF" #colour of title text
author_textcol: "ffffff" # Colour of author text
affiliation_textcol: "ffffff" # Colour of affiliation text
title_textsize: "Huge"         # Poster title fontsize
author_textsize: "Large"       # Author list font size
affiliation_textsize: "large"  # Affiliation font size
#ADDING LOGOS
logoleft_name: 'Figures/shesc'
logoleft_width: '5in'
logoleft_xshift: '1in'
logoleft_yshift: '1in'
logoright_name: 'Figures/quantarch3'
logoright_width: '5in'
logoright_xshift: '-1in'
logoright_yshift: '1in'

#---POSTER BODY OPTIONS---#
body_bgcol: "ffffff" #colour of the poster main background
body_textsize: "normalsize"    # Size of the main poster body text
body_textcol: "594F4F"#000000" # Colour of main text in the body of poster
column_numbers: 3 # Number of columns that the poster has
column_margins: "0.5in" # Margin spacing for columns
columnline_col: "008080" #colour 
columnline_width: "0pt" #width of line between each column
#SECTION TITLE STYLING
sectitle_textcol: "ffffff" # Colour of the poster section titles
sectitle_bgcol: "433E85" # Colour of the section title box
sectitle_bordercol: "433E85" # Colour of the border around the section title box.
sectitle_borderwidth: "2mm" # Thicknes of the section title box border
sectitle_boxshape: "uphill" # Changes the shape of the section title box.

#---BIBLIOGRAPHY OPTIONS---#
bibliography: MyLibrary # name of the .bib file used for referencing
bibliography_spacing: 0.8 # sets the multiplier for line spacing of bibliography spacing (between 0 and 1)
bibliography_textsize: "small"  # size of the bibliography text size (handy for one too many references!)

#---OTHER---#
cite_col: "CC0000" #colour of ciation elements
url_col: "008080" #colour of url links
link_col: "008080" #colour of other links within the poster
footnote_textcol: "ffffff" # Colour of footnote text if used
output: posterdown::posterdown_latex
---

```{r, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, results = 'asis', out.width = "80%", warning = FALSE, fig.align = 'center', message = FALSE, dev='cairo_pdf', cache = TRUE)
```

```{r}
#devtools::install_github('brentthorne/posterdown')
#library(posterdown)
library(maps)
library(tidyverse)
library(readxl)
library(mgcv)
library(ggmap)
library(sf)
#devtools::install_github('nspope/corMLPE')
library(corMLPE)
library(tidygraph)

# need dev version of ggraph devtools::install_github('thomasp85/ggraph')
library(ggraph)
library(archdata)
```

# What are GAMMs?

Generalized additive models (GAMs) and their variants Generalized additive *mixed* models (GAMMs) are a flexible family of regression models that capture the complexity of the archaeological record.

\vspace{1cm}

**Let's break it down:**

* *Generalized* -- Model non-normal distributions such as counts or proportions
* *Additive* -- Combine linear and non-linear relationships
* *Mixed* -- Control for network, spatial, and temporal autocorrelation

# What can I do with them?

In archaeology, they're particuarly useful for fitting so-called ``maximum-entropy'' spatial interaction models. These models estimate the *flow* of goods, information, or people between spatially-structured populations as a function of the origin site, destination site, and the space between them:

\vspace{1cm}

\begin{center}
  \includegraphics[width=.4\columnwidth]{Figures/network_diagram.png}
\end{center}
$$flow = f\left(origin\right) \times f\left(destination\right) \times f\left(distance\right)$$
```{r, eval = FALSE, fig.width = 6, fig.height = 4, out.width = "40%"}
tbl_graph(nodes = tibble(size = c(50, 100, 150), x = 1:3, y = c(1,2,1)), 
          edges = expand.grid(from = 1:3, to = 1:3)) %E>%
  mutate(distance = sqrt((.N()$x[from] - .N()$x[to])^2 + (.N()$y[from] - .N()$y[to])^2),
         weight = .N()$size[from]^1.15 * .N()$size[to] * exp(-0.15 * distance)) %>%
  ggraph() +
  geom_edge_fan(aes(width = weight, alpha = ..index.., color = weight), show.legend = FALSE) +
  geom_node_point(aes(size = size), show.legend = FALSE) +
 scale_size(range = c(5,15)) +
 scale_edge_color_distiller(palette = 'YlGnBu') +
  scale_color_distiller(palette = 'YlGnBu') +
  theme_void() 
```

The difficult part comes when we have to define the $f\left(\right)$s. Economic geographers often use a generalized *linear* model (GLM), which requires them to definte the $f\left(\right)$ ahead of time. In a GAM, the $f\left(\right)$s are estimated directly from the data using splines.

\vspace{1cm}

# How do they work?
Real-world splines are flexible strips of metal or wood used to draw curves. Mathematical splines are complex curves made of many smaller, simpler curves. *Penalized* regression splines can estimate $f\left(\right)$ from the data, limiting overfitting by penalizing the "wiggliness" of the function.

\begin{center}
\includegraphics[width=.3\columnwidth]{Figures/spline.png}
\end{center}

\vspace{1cm}

# Case Studies
\\
```{r}
data("OxfordPots")
pots <- OxfordPots %>%
  rename(to = Place) %>%
  gather(key, value, OxfordPct:NewForestDst) %>%
  separate(key, c('from', 'measure'), sep = -3) %>%
  spread(measure, value) %>%
  rename(percent = Pct, distance = Dst) %>%
  mutate(from = str_replace(from, 'NewForest', 'New Forest'))

pots_sites <- readRDS('data/oxfordpots_locations.RDS') %>%
  left_join(dplyr::select(pots, to, WalledArea) %>% group_by(to) %>% 
              summarise(area = mean(WalledArea)), by = c('site' = 'to'))

pots_net <- tbl_graph(nodes = pots_sites, edges = pots, directed = TRUE) %E>%
  filter(!is.na(percent)) %>%
  mutate(similarity = percent / 100)

uk_boundary <- maps::map('world', region = 'UK',
                    fill = TRUE, plot = FALSE) %>%
  st_as_sf

pots_dat <- pots_net %E>%
  mutate(water = as.factor(WaterTrans == 1),
         x = .N()$x[to],
         y = .N()$y[to]) %>% 
  as_tibble %>%
  mutate(from = as.factor(from),
         to = as.factor(to))
```

```{r, fig.cap = "Percentages of late Romano-British pottery produced in Oxford and New Forest."}
pots_net %E>%
  arrange(percent) %N>%
ggraph(., layout = 'manual', x = as_tibble(.)$x, y = as_tibble(.)$y) +
  geom_sf(data = uk_boundary, fill = NA) +
  geom_edge_link(aes(colour = percent), edge_width = 2, lineend = 'round') +
  geom_sf(data = filter(pots_sites, site %in% c('Oxford', 'New Forest')), size = 4) +
  scale_edge_color_viridis(guide = 'legend', name = 'Percentage of pottery \nfrom origin site') +
  coord_sf(datum = NA, xlim = c(-6, 2), ylim = c(50, 53.8)) +
  theme_void()
```

## Ceramic distribution in Roman Britain

First is a dataset of Late Romano-British pottery. We have data for the percentage of the ceramic assemblage at 30 sites that were produced at Oxford or New Forest, and want to understand something about how these pots were moved over space.

```{r}
chumash_villages <- read_csv('data/chumash_villages.csv') %>%
  st_as_sf(coords = c('x', 'y'), crs = 4326) %>%
  bind_cols(., as_tibble(st_coordinates(.))) %>%
  rename(x = X, y = Y) %>%
  mutate(size = ordered(size, levels = c('hamlet', 'small', 'medium', 'large', 'very large', 'largest'))) 

chumash_net <- read.csv('data/chumash_marriages.csv', row.names = 1) %>%
  as.matrix %>% 
  replace(. == 0, 999) %>% # replace 0 values with 999 temporarily
  as_tbl_graph(directed = FALSE) %E>%
  filter(!edge_is_loop()) %>%
  rename(marriages = weight) %>%
  mutate(marriages = if_else(marriages == 999, 0, marriages))%N>%
  mutate(centrality = centrality_degree(weights = marriages)) %>%
  left_join(chumash_villages, by = c('name' = 'village')) %E>%
  mutate(distance = st_distance(.N()$geometry[from], .N()$geometry[to], by_element = TRUE),
         distance = as.numeric(distance) / 1000,
         population = .N()$baptisms[from] * .N()$baptisms[to],
         population_add = .N()$baptisms[from] + .N()$baptisms[to],
         eco_same = as.factor(.N()$coastal[from] == .N()$coastal[to]))

ca_boundary <- maps::map('county', region = 'California',
                    fill = TRUE, plot = FALSE) %>%
  st_as_sf
```

```{r}
chumash_net %E>%
  arrange(marriages) %>%
  #filter(marriages > 1) %>%
ggraph() +
  geom_edge_link(aes(colour = marriages, alpha = marriages, edge_width = marriages), lineend = 'round') +
  geom_node_point(aes(size = baptisms)) +
  #scale_edge_color_distiller(palette = 'YlGnBu', guide = 'legend') + 
  scale_edge_color_viridis() +
  theme_void() +
  scale_size_area(name = 'Population (est)') +
  #coord_quickmap()+
  theme(legend.position = 'bottom') +
  geom_sf(data = ca_boundary, fill = NA) +
  coord_sf(datum = NA, xlim = c(-120.60246, -119.48277), ylim = c(34.38628, 34.74438))
```

## Chumash marriage networks

Next we'll look at a dataset of XX840XX marriages between 41 Chumash villages near Santa Barbara, California, as recorded by Spanish missionaries. Populations are estimated from baptism records.


\vspace{1cm}
\vspace{1cm}
\vspace{1cm}
\vspace{1cm}
\vspace{1cm}
\vspace{1cm}

# Results

```{r}
m1 <- gam(similarity ~ s(distance, by = water) + water + from,
          method = 'REML', # algorithm to estimate the GAM
          select = TRUE, # allow some variables to be selected out
          family = betar(), # beta distribution between 0 and 1
          data = pots_dat)
```

We can look at the spline functions fit by the GAM. These suggest that overland travel is subject to logarithmic distance decay, but water transport seems to have no such constraints.

```{r, out.width = "30%", out.width=".49\\columnwidth", fig.align='center', fig.show='hold', fig.cap = "Estimated distance decay functions, with and without water transport."}
tmp1 <- expand.grid(distance = 0:140, water = c(TRUE, FALSE), from = 2)
predict(m1, tmp1, type = 'response', se.fit = TRUE) %>%
  bind_cols(tmp1) %>%
  mutate(fit = fit * 100,
         lower = fit - 2 * se.fit * 100,
         upper = fit + 2 * se.fit * 100) %>%
  ggplot(aes(distance, fit, group = water)) +
  geom_ribbon(aes(ymin = lower, ymax = upper, fill = water), alpha = .2) +
  geom_line(aes(y = fit, color = water), size = 1.2) +
  #scale_color_manual(values = c('#253494', '#41b6c4')) +
  #scale_fill_manual(values = c('#253494', '#41b6c4')) +
  scale_color_viridis_d() +
  scale_fill_viridis_d() +
  theme_classic() +
  labs( x = 'Distance (km)', y = 'Percentage of pottery from origin site')

pots_net %E>%
  mutate(res = residuals(m1, type = 'response') * 100) %>%
  arrange(abs(res)) %N>%
ggraph(., layout = 'manual', x = as_tibble(.)$x, y = as_tibble(.)$y) +
  geom_sf(data = uk_boundary, fill = NA) +
  geom_edge_link(aes(colour = res), edge_width = 2, lineend = 'round') +
  geom_sf(data = filter(pots_sites, site %in% c('Oxford', 'New Forest')), size = 4) +
  scale_edge_color_distiller(palette = 'RdBu', limits = c(-8, 8), labels = paste0(seq(-8, 8, by = 4), '%'), guide = 'legend', name = '') +
  coord_sf(datum = NA, xlim = c(-6, 2), ylim = c(50, 53.8)) +
  theme_void()
```

Finally, by examining the residuals of the basic spatial interaction model, we can focus on the links that are unusually stronger or weaker than expected for further study.

```{r, out.width = "30%", eval= TRUE, fig.cap="Residuals from a distance-only interaction model. Red ties are stronger then expected, blue ties weaker."}

```

We can model these data by regressing the count of marriages between each village pair on the product of their populations and the distance between them.

```{r, include = FALSE}
m1 <- gamm(marriages ~ te(distance, population) + eco_same,
      method = 'REML',
      select = TRUE,
      family =  quasipoisson(),#Tweedie(p = 1.2, link = 'log'),
      correlation = corMLPE(form = ~from + to),
      data =  as_tibble(activate(chumash_net, 'edges')))
```

```{r, out.width=".49\\columnwidth", fig.align='center', fig.show='hold'}
expand_grid(population = seq(0, 50000, 100),
            distance = seq(0, 50, 0.1),
            eco_same = FALSE) %>%
  mutate(marriages = predict(m1$gam, ., type = 'response')) %>%
  ggplot(aes(distance, population, fill = marriages)) +
  geom_raster() +
  scale_fill_viridis_c(guide = 'legend') +
  theme_classic() +
  coord_fixed(ratio = .001)

vis.gam(m1$gam, view = c('distance', 'population'), theta = 45, phi = 15, type = 'response', se = -1, color = 'bw')
```

# What's next?

GAMs can fit many different kinds of functions, with spatial, temporal, and network autocorrelation. Many response types such as counts, percents, binary, categories, ordered categories, hazard models. Use the package `mgcv` in `R`. Bayesian implementations in `brms`. Scan this QR code, or go to https://github.com/nick-gauthier/gam-networks to find the R code used to make this poster, along with more detailed worked examples.

\begin{center}
\includegraphics[width=5in]{Figures/qr}
\end{center}


\small\printbibliography
